<!DOCTYPE html><html><head><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta charset="utf-8"><title># 要做什么：登陆一键爬取 kkb 所有会员课程 - Documents</title><meta name="description" content=""><meta name="author" content=""><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><link rel="stylesheet" href="../assets/css/bulma.min.css"><link rel="stylesheet" href="../assets/css/app.css"><!--[if lt IE 9]>
<script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]--><link rel="shortcut icon" href=""></head><body dir="ltr"><nav class="columns navbar"><div class="column logo is-3 is-offset-1"><a class="is-brand" href="../index.html">Documents</a></div></nav><div class="columns content"><div class="column is-2-desktop is-3-widescreen is-hidden-touch"></div><div class="column article-container is-11-tablet is-8-desktop is-6-widescreen"><div class="breadcrumb-area"><a href="../index.html" class="breadcrumb-item">Home</a><span class="breadcrumb-delimiter"> &gt; </span><a href="../前端爬虫/index.html" class="breadcrumb-item">前端爬虫</a><span class="breadcrumb-delimiter"> &gt; </span><a href="../前端爬虫/4. 实战：kkb一键爬取所有vip课程.html" class="breadcrumb-item">4. 实战：kkb一键爬取所有vip课程.md</a></div><h1 class="article-title"># 要做什么：登陆一键爬取 kkb 所有会员课程</h1><div class="article"><figure><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h57iw72753j21100ik0w3.jpg" alt=""><figcaption>image-20220815161855513</figcaption></figure><h3 id="整体思路">整体思路 <a class="markdownIt-Anchor" href="#整体思路">#</a></h3><p>我们的目标是生成对应的目录并下载对应资源（课件和视频），开课吧的课程结构是【一门课对应多个章，每个章对应多个节，每个小节对应多个课程】；Kkb 对应接口如下，以下接口需要【课程 id 课程名称 accessToken Authorization cookie】</p><pre class="hljs"><code><span class="hljs-comment">// 课程接口，可以获取所有章id</span>
<span class="hljs-keyword">const</span> courseUrl = <span class="hljs-string">`https://weblearn.kaikeba.com/student/courseinfo?course_id=<span class="hljs-subst">${course_id}</span>&amp;__timestamp=1653898285046`</span>;
<span class="hljs-comment">// 章详情接口，可以获取章下对应所有节id</span>
<span class="hljs-keyword">const</span> chapterUrl = <span class="hljs-string">`https://weblearn.kaikeba.com/student/chapterinfo?course_id=<span class="hljs-subst">${course_id}</span>&amp;chapter_id=`</span>;
<span class="hljs-comment">// 节详情，可以获取节下所有对应课程视频地址</span>
<span class="hljs-keyword">const</span> mediaUrl = <span class="hljs-string">&quot;https://api-vod.baoshiyun.com/vod/v1/platform/media/detail&quot;</span>;
</code></pre><p>所以这里主要思路就是</p><ol><li><p>信息生成：获取先利用 puppeteer 模拟用户登录，爬取所有 vip 课程，生成对应信息（课程 id 课程名称 accessToken Authorization cookie）</p></li><li><p>资源下载：进行目录的生成和资源的下载，分为两类</p><ul><li><p>pdf、html 等静态资源文档：直接 stream 请求去进行下载</p></li><li><p>视频：每个视频是 m3u8 类型文件，我们需要的是 mp4 文件，这里通过 ffmpeg 实现【请求 m3u8 - 转本地 mp4】，以 txt 文件作为载体存储小节对应所有课程视频 ffmpeg 命令</p></li></ul></li></ol><p><strong>优化</strong>：这个放本地跑太耽误事儿了，可以放云服务器，这就涉及到</p><ol><li>本地和云服务器的文件传输（scp、rsync）</li><li>云服务器的脚本后台运行（nohup）</li><li>linux 适配：中文适配，ffmpeg 开启 https 协议、puppeteer 运行失败处理</li><li>命令批量执行</li><li>百度云盘上传：<a href="https://www.upstudy.top/index.php/archives/50/" target="_blank" rel="noopener">https://www.upstudy.top/index.php/archives/50/</a></li></ol><h3 id="具体步骤">具体步骤 <a class="markdownIt-Anchor" href="#具体步骤">#</a></h3><h5 id="信息生成">信息生成 <a class="markdownIt-Anchor" href="#信息生成">#</a></h5><ol><li>获取 cookie 实现页面登陆：EditCookies</li><li>切换我的课程页，筛选 vip 课程：模拟用户点击行为</li><li>拦截课程 list 接口，获取对应课程信息，从而获取对应的 cookie、课程 id 和课程名：拦截接口请求</li><li>循环开启新 tab，进入对应的详情页：新开 tab 页，单例模式</li><li>模拟用户行为触发视频播放事件，拦截课程 detail 接口，获取 actoken：模拟用户点击行为 + 拦截接口请求</li></ol><h5 id="资源下载">资源下载 <a class="markdownIt-Anchor" href="#资源下载">#</a></h5><ol><li>触发接口，生成所有 vip 课程的目录结构、静态资源和对应所有课程视频转码 ffepmg 命令（存储在 txt 文件中），这里需要批量处理，开始使用了 node 中的 glob，后面需要使用 es6 模块化机制，所以使用了 webpack 中的 require.context</li><li>收集所有 vip 课程的 ffepmg 命令 txt 文件，生成一个二维数组，【第一个元素是文件地址；第二个是对应的子目录数组】</li><li>根据命令生成对应的<code>download.sh</code>脚本文件，包含所有 ffepmg 命令</li><li>触发此 download.sh，下载启动；</li></ol><h5 id="移植云服务器">移植云服务器 <a class="markdownIt-Anchor" href="#移植云服务器">#</a></h5><p>本地和云服务器的文件传输（scp、rsync），开始采用 scp，后面需要忽略 node_modules 和.git 文件，所以采用了 rsync（不用 github 的原因是因为本地已经开始下载了，有中文目录，而.gitignore 不支持中文目录的忽略）</p><p>详情可见文章：<a href="https://www.myfreax.com/how-to-exclude-files-and-directories-with-rsync/" target="_blank" rel="noopener">https://www.myfreax.com/how-to-exclude-files-and-directories-with-rsync/</a></p><pre class="hljs"><code>rsync -av [本地目录]  root@[ip]:[远端目录] --exclude='[忽略目录1]'  --exclude '[忽略目录2]'
</code></pre><h5 id="云服务器的脚本后台运行">云服务器的脚本后台运行 <a class="markdownIt-Anchor" href="#云服务器的脚本后台运行">#</a></h5><p>可见文档：<a href="https://w1k5uc4805.feishu.cn/docx/doxcnuEFTvpQLDBOgiYFERM0Hne" target="_blank" rel="noopener">https://w1k5uc4805.feishu.cn/docx/doxcnuEFTvpQLDBOgiYFERM0Hne</a></p><h5 id="linux-适配">linux 适配 <a class="markdownIt-Anchor" href="#linux-适配">#</a></h5><ul><li><p>中文适配：<a href="https://w1k5uc4805.feishu.cn/file/boxcnOAbJJyaYHBrBQnftXvzdwI" target="_blank" rel="noopener">https://w1k5uc4805.feishu.cn/file/boxcnOAbJJyaYHBrBQnftXvzdwI</a></p></li><li><p>ffmpeg 开启 https 协议：<a href="https://blog.csdn.net/w839687571/article/details/99707201" target="_blank" rel="noopener">https://blog.csdn.net/w839687571/article/details/99707201</a></p></li><li><p>puppeteer 运行失败处理：</p><ul><li>Error: Failed to launch the browser process：<a href="https://github.com/puppeteer/puppeteer/issues/5361" target="_blank" rel="noopener">https://github.com/puppeteer/puppeteer/issues/5361</a></li><li>run npm install to download the correct chromium：<a href="https://thestye.com/bash/could-not-find-expected-browser-chrome-locally-run-npm-install-to-download-the-correct-chromium/" target="_blank" rel="noopener">https://thestye.com/bash/could-not-find-expected-browser-chrome-locally-run-npm-install-to-download-the-correct-chromium/</a></li></ul></li></ul><h5 id="npm-run-all">npm-run-all <a class="markdownIt-Anchor" href="#npm-run-all">#</a></h5><p>可见：<a href="https://juejin.cn/post/6854573216363446286" target="_blank" rel="noopener">https://juejin.cn/post/6854573216363446286</a></p><h2 id="怎么做到尽可能做到复制粘贴就能有成果">怎么做到：尽可能做到复制粘贴就能有成果 <a class="markdownIt-Anchor" href="#怎么做到尽可能做到复制粘贴就能有成果">#</a></h2><ol><li>kkb-Web：用户端(谷歌插件)，输入 cookie 和包名，发起请求从而触发下载；其中 isDev 开启时就会触发本地的 3000 端口(<a href="https://github.com/Sympath/kkb-down-web" target="_blank" rel="noopener">https://github.com/Sympath/kkb-down-web</a>)</li><li>kkb-serve：服务端，接收请求，接收后进行下载【download-sh】仓库并输入依赖，执行课程下载流程（<a href="https://github.com/Sympath/download-serve%EF%BC%89" target="_blank" rel="noopener">https://github.com/Sympath/download-serve）</a></li><li>download-sh：下载流程脚本（<a href="https://github.com/Sympath/download-sh%EF%BC%89" target="_blank" rel="noopener">https://github.com/Sympath/download-sh）</a></li><li>kkb-download：核心下载模块（<a href="https://github.com/Sympath/kkb-download%EF%BC%89" target="_blank" rel="noopener">https://github.com/Sympath/kkb-download）</a></li></ol><h2 id="课后作业用于感兴趣同学的拔高">课后作业：用于感兴趣同学的拔高 <a class="markdownIt-Anchor" href="#课后作业用于感兴趣同学的拔高">#</a></h2><ol><li>家庭作业第一项：优先读五遍 + 完成要求</li><li>【形象拼音上】11 页，画勾的拼音完成拼读</li></ol></div><div dir="ltr" class="level article-bar is-mobile"><div class="level-item has-text-centered"><a title="previous page" class="previouse-article-link" href="../前端爬虫/3. 展示应用实现.html"><span class="icon icon-previous" data-icon="previous"></span><span class="link-content">&laquo; Previous</span></a></div><div class="level-item has-text-centered"><a title="font size" class="link-item link-item-size"><span class="icon icon-size" data-icon="size"></span></a></div><div class="level-item has-text-centered"><a title="table of content" class="link-item link-item-toc"><span class="icon icon-toc" data-icon="toc"></span></a></div><div class="level-item has-text-centered"><a title="top" href="#"><span class="icon icon-up" data-icon="up"></span> <span class="link-content">⤊ Top</span></a></div><div class="level-item has-text-centered"><a title="next page" class="next-article-link" href="../前端爬虫/开营计划.html"><span class="icon icon-next" data-icon="next"></span><span class="link-content">Next &raquo;</span></a></div></div></div><div class="column is-2-widescreen is-hidden"></div></div><div class="columns foot"><div class="column is-3 is-offset-9 build-by">Build by <a href="https://github.com/ruanyf/loppo" target="_blank">Loppo</a> 0.6.24</div></div><div class="book-toc notification is-warning is-hidden"><h3>Table of chapters &nbsp;<span class="title-close"><a class="button is-danger"> Close</a></span></h3><ul class="chapter-area"><li class="chapter-item"><a href="../shell编程训练营/index.html">shell编程训练营</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../shell编程训练营/1. Shell 的基本介绍、常用命令以及 Shell 的流程控制.html">我们为什么要学习shell</a></li><li class="chapter-item"><a href="../shell编程训练营/2. Shell 中的数组应用、参数处理和函数的应用.html">shell之语句</a></li><li class="chapter-item"><a href="../shell编程训练营/3. Shell 的函数、模块化、公共函数库.html">shell之函数</a></li><li class="chapter-item"><a href="../shell编程训练营/4. Shell周边：语言特殊点调试 Debug 方案vscode对shell的支持.html">语言特殊点</a></li><li class="chapter-item"><a href="../shell编程训练营/开营前置信息.html">开营前置信息.md</a></li></ul><li class="chapter-item"><a href="../vscode训练营/index.html">vscode训练营</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../vscode训练营/day1：简单了解插件开发.html">day1：简单了解插件开发.md</a></li><li class="chapter-item"><a href="../vscode训练营/day2：实现一个简单代码工具.html">day2：实现一个简单代码工具.md</a></li><li class="chapter-item"><a href="../vscode训练营/day3：vscode配置文件.html">day3：vscode配置文件.md</a></li><li class="chapter-item"><a href="../vscode训练营/day4：完善工具，添加更多功能并发布.html">然后输入之前获取到的 token</a></li><li class="chapter-item"><a href="../vscode训练营/开营计划.html">开营计划.md</a></li></ul><li class="chapter-item"><a href="../webpack插件训练营/index.html">webpack插件训练营</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../webpack插件训练营/day1. 简单了解webpack.html">day1. 简单了解webpack.md</a></li><li class="chapter-item"><a href="../webpack插件训练营/day2. webpack配置文件拆分及开发环境搭建.html">day2. webpack配置文件拆分及开发环境搭建.md</a></li><li class="chapter-item"><a href="../webpack插件训练营/day3. 文件类型处理篇.html">day3. 文件类型处理篇.md</a></li><li class="chapter-item"><a href="../webpack插件训练营/day4. 性能分析篇.html">day4. 性能分析篇.md</a></li><li class="chapter-item"><a href="../webpack插件训练营/day5. 性能优化篇：体积优化.html">day5. 性能优化篇：体积优化.md</a></li><li class="chapter-item"><a href="../webpack插件训练营/day6. 性能优化篇：缓存.html">day6. 性能优化篇：缓存.md</a></li><li class="chapter-item"><a href="../webpack插件训练营/day7. webpack 核心工作流程.html">day7. webpack 核心工作流程.md</a></li><li class="chapter-item"><a href="../webpack插件训练营/day8. 熟悉插件和loader的发布流程.html">day8. 熟悉插件和loader的发布流程.md</a></li><li class="chapter-item"><a href="../webpack插件训练营/开营计划.html">开营计划.md</a></li><li class="chapter-item"><a href="../webpack插件训练营/提效技巧篇：px转rem.html">提效技巧篇：px转rem.md</a></li><li class="chapter-item"><a href="../webpack插件训练营/提效技巧篇：基于glob实现自动化路由的MPA.html">提效技巧篇：基于glob实现自动化路由的MPA.md</a></li><li class="chapter-item"><a href="../webpack插件训练营/提效技巧篇：浏览器前缀自动添加.html">提效技巧篇：浏览器前缀自动添加.md</a></li></ul><li class="chapter-item"><a href="../前端爬虫/index.html">前端爬虫</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-collapse" data-icon="collapse"></span></a></li><ul class="chapter-level-1 chapter-level-1-current"><li class="chapter-item"><a href="../前端爬虫/1. 了解爬虫 - puppetter实战.html">1. 了解爬虫 - puppetter实战.md</a></li><li class="chapter-item"><a href="../前端爬虫/2. 数据入库.html">2. 数据入库.md</a></li><li class="chapter-item"><a href="../前端爬虫/3. 展示应用实现.html">3. 展示应用实现.md</a></li><li class="chapter-item chapter-item-current"><a href="../前端爬虫/4. 实战：kkb一键爬取所有vip课程.html">4. 实战：kkb一键爬取所有vip课程.md</a></li><li class="chapter-item"><a href="../前端爬虫/开营计划.html">开营计划.md</a></li></ul></ul><li class="chapter-item"><a href="../学习小组规划.html">学习小组规划.md</a></li><li class="chapter-item"><a href="../开营计划.html">开营计划.md</a></li><li class="chapter-item"><a href="../模板.html">模板.md</a></li><li class="chapter-item"><a href="../谷歌浏览器插件/index.html">谷歌浏览器插件</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../谷歌浏览器插件/开营计划.html">开营计划.md</a></li></ul></div><div class="progress-indicator"></div><!-- SCRIPTS --><script>var LOPPO={current_path:"前端爬虫/4. 实战：kkb一键爬取所有vip课程.md",relative_root_path:"../",article_toc:'<ul class="markdownIt-TOC">\n<li>\n<ul>\n<li><a href="#%E6%95%B4%E4%BD%93%E6%80%9D%E8%B7%AF">整体思路</a></li>\n<li><a href="#%E5%85%B7%E4%BD%93%E6%AD%A5%E9%AA%A4">具体步骤</a></li>\n</ul>\n</li>\n<li><a href="#%E6%80%8E%E4%B9%88%E5%81%9A%E5%88%B0%E5%B0%BD%E5%8F%AF%E8%83%BD%E5%81%9A%E5%88%B0%E5%A4%8D%E5%88%B6%E7%B2%98%E8%B4%B4%E5%B0%B1%E8%83%BD%E6%9C%89%E6%88%90%E6%9E%9C">怎么做到：尽可能做到复制粘贴就能有成果</a></li>\n<li><a href="#%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9A%E7%94%A8%E4%BA%8E%E6%84%9F%E5%85%B4%E8%B6%A3%E5%90%8C%E5%AD%A6%E7%9A%84%E6%8B%94%E9%AB%98">课后作业：用于感兴趣同学的拔高</a></li>\n</ul>\n'}</script><script src="../assets/js/app.js"></script></body></html>